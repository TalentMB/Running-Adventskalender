<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>TMB-Running-Adventskalender</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flashes {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="header-container">
        <h1>TMB-Running-Adventskalender</h1>
        <a href="{{ url_for('logout') }}" class="btn view-only-btn">Abmelden / Team wechseln</a>
    </div>

    <div class="dashboard-stats">
        <h4>Aktuelles Team: {{ team_name }}</h4>
        <!-- Gesamt gelaufen Text entfernt -->

        <h4>Teammitglieder:</h4>
        <div class="user-list">
            {% for user in users %}
                <span style="color: {{ user.farbe }}; font-weight: bold;">● {{ user.name }}</span>
            {% endfor %}
        </div>

        {% if can_write %}
            <!-- Formular zum Nutzer hinzufügen -->
            <form method="POST" action="{{ url_for('add_user') }}" style="margin-top: 15px;">
                <input type="text" name="neuer_nutzer_name" placeholder="Name des neuen Nutzers" required>
                <button type="submit">Nutzer hinzufügen</button>
            </form>
        {% endif %}
    </div>


    <!-- Der Kalenderbereich -->
    <h2>Der Adventskalender</h2>

    <div class="tuer-grid">
        {% for tuer in tuer_liste %}
            <div class="tuer-card {% if tuer.ist_erledigt %}tuer-erledigt{% endif %}"
                 data-total-km="{{ tuer.ziel_km }}"
                 data-reached-km="{{ tuer.erreicht_km | round(1) }}">

                <div class="tuer-content-wrapper">
                    <!-- Linke Seite: Kreisdiagramm (Link zur Eingabe) -->
                    <a href="{{ url_for('lauf_erfassen_formular', tuer_db_id=tuer.id) }}" class="tuer-nummer-kreis" title="Klicken zum Kilometer eintragen">
                        {{ tuer.tuer_nummer }}
                    </a>

                    <!-- Rechte Seite: Hier zeigen wir nur die individuellen Beiträge als Text an -->
                    <div class="tuer-actions-side">
                        <div class="tuer-beitraege-text">
                            <!-- Hier iterieren wir durch die Beiträge und zeigen sie an -->
                            {% for beitrag in tuer.beitraege %}
                                <div style="color: {{ beitrag.farbe }};">
                                    {{ beitrag.user_name }}: {{ beitrag.km | round(1) }} km
                                </div>
                            {% endfor %}

                            <!-- Die Gesamt-Anzeige innerhalb des Türchens wurde entfernt -->
                        </div>

                        {% if can_write and tuer.erreicht_km > 0 %}
                            <!-- Rotes X zum Zurücksetzen -->
                            <form method="POST" action="{{ url_for('tuer_zuruecksetzen', tuer_db_id=tuer.id) }}">
                                <button type="submit" class="reset-btn" title="Türchen zurücksetzen (Alle Läufe löschen)">
                                    ✖
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <!-- Das Skript für den Kreis beibehalten -->
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            document.querySelectorAll('.tuer-card').forEach(card => {
                const totalKm = parseFloat(card.dataset.totalKm);
                const reachedKm = parseFloat(card.dataset.reachedKm);

                // 1. Logik für den Kreis (Gesamtfortschritt Rot/Grün)
                const kreis = card.querySelector('.tuer-nummer-kreis');
                const progress = (reachedKm / totalKm) || 0;
                const color = progress >= 1 ? '#28a745' : '#FF4500';
                const percentage = progress * 100;
                const gradientStringKreis = `conic-gradient(${color} 0% ${percentage}%, #eee ${percentage}% 100%)`;
                kreis.style.backgroundImage = gradientStringKreis;
                card.title = `Erreicht: ${reachedKm} km von ${totalKm} km`;
            });
        });
    </script>

</body>
</html>
